{% extends "base.html" %}

{% block title %}Stock Prediction{% endblock %}

{% block content %}
<div class="container mt-5">
    <h1 class="text-center mb-5">üîÆ Stock Price Prediction</h1>

    <div class="row mb-4">
        <div class="col-md-12">
            <div class="card">
                <div class="card-body">
                    <h5 class="card-title">Prediction Parameters</h5>
                    <form id="predictionForm">
                        <div class="row">
                            <div class="col-md-3">
                                <label>Stock Symbol</label>
                                <input type="text" class="form-control" id="symbol" value="AAPL" required>
                            </div>
                            <div class="col-md-3">
                                <label>Model Type</label>
                                <select class="form-control" id="model">
                                    <option value="Random Forest">Random Forest (Recommended)</option>
                                    <option value="ARIMA">ARIMA</option>
                                </select>
                            </div>
                            <div class="col-md-2">
                                <label>Forecast Days</label>
                                <input type="number" class="form-control" id="days" value="30" min="7" max="90">
                            </div>
                            <div class="col-md-2">
                                <label>Start Date</label>
                                <input type="date" class="form-control" id="startDate">
                            </div>
                            <div class="col-md-2">
                                <label class="d-block">&nbsp;</label>
                                <button type="submit" class="btn btn-primary w-100">
                                    <i class="fas fa-play"></i> Predict
                                </button>
                            </div>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- Loading Spinner -->
    <div id="loading" class="text-center" style="display:none;">
        <div class="spinner-border text-primary" role="status">
            <span class="visually-hidden">Loading...</span>
        </div>
        <p class="mt-2">Generating predictions... ‚è≥</p>
    </div>

    <!-- Results -->
    <div id="results" style="display:none;">
        <div class="row mb-4">
            <div class="col-md-12">
                <div class="card">
                    <div class="card-body">
                        <h5>Prediction Chart</h5>
                        <canvas id="predictionChart"></canvas>
                    </div>
                </div>
            </div>
        </div>

        <div class="row">
            <div class="col-md-4">
                <div class="card text-center">
                    <div class="card-body">
                        <h6 class="text-muted">RMSE</h6>
                        <h3 id="rmse">-</h3>
                    </div>
                </div>
            </div>
            <div class="col-md-4">
                <div class="card text-center">
                    <div class="card-body">
                        <h6 class="text-muted">MAE</h6>
                        <h3 id="mae">-</h3>
                    </div>
                </div>
            </div>
            <div class="col-md-4">
                <div class="card text-center">
                    <div class="card-body">
                        <h6 class="text-muted">MSE</h6>
                        <h3 id="mse">-</h3>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
let predictionChart;

document.getElementById('predictionForm').addEventListener('submit', function(e) {
    e.preventDefault();
    
    const symbol = document.getElementById('symbol').value;
    const model = document.getElementById('model').value;
    const days = document.getElementById('days').value;
    const startDate = document.getElementById('startDate').value;
    
    document.getElementById('loading').style.display = 'block';
    document.getElementById('results').style.display = 'none';
    
    fetch('/prediction/forecast', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({
            symbol: symbol,
            model: model,
            days: days,
            start_date: startDate
        })
    })
    .then(res => res.json())
    .then(data => {
        document.getElementById('loading').style.display = 'none';
        
        if (data.success) {
            displayResults(data);
        } else {
            alert('‚ùå Error: ' + data.error);
        }
    })
    .catch(err => {
        document.getElementById('loading').style.display = 'none';
        alert('‚ùå Error generating prediction');
    });
});

function displayResults(data) {
    document.getElementById('results').style.display = 'block';
    
    // Display metrics
    document.getElementById('rmse').innerText = data.metrics.RMSE;
    document.getElementById('mae').innerText = data.metrics.MAE;
    document.getElementById('mse').innerText = data.metrics.MSE;
    
    // Create chart
    const ctx = document.getElementById('predictionChart').getContext('2d');
    
    if (predictionChart) {
        predictionChart.destroy();
    }
    
    predictionChart = new Chart(ctx, {
        type: 'line',
        data: {
            labels: [...data.historical.dates, ...data.forecast.dates],
            datasets: [{
                label: 'Historical Prices',
                data: data.historical.actual.map((val, idx) => ({x: data.historical.dates[idx], y: val})),
                borderColor: 'rgb(75, 192, 192)',
                backgroundColor: 'rgba(75, 192, 192, 0.1)',
                tension: 0.1
            }, {
                label: 'Predicted Prices',
                data: data.forecast.values.map((val, idx) => ({x: data.forecast.dates[idx], y: val})),
                borderColor: 'rgb(255, 99, 132)',
                backgroundColor: 'rgba(255, 99, 132, 0.1)',
                borderDash: [5, 5],
                tension: 0.1
            }]
        },
        options: {
            responsive: true,
            plugins: {
                title: {
                    display: true,
                    text: `${data.symbol} - ${data.model} Prediction`
                }
            },
            scales: {
                y: {
                    beginAtZero: false,
                    title: {
                        display: true,
                        text: 'Price ($)'
                    }
                }
            }
        }
    });
}
</script>
{% endblock %}