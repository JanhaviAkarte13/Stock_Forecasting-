{% extends "base.html" %}

{% block title %}Dashboard{% endblock %}

{% block content %}
<div class="container-fluid mt-4">
    <div class="row mb-4">
        <div class="col-12">
            <h2>üìä Welcome, {{ username }}!</h2>
            <p class="text-muted">Real-time market overview and analytics</p>
        </div>
    </div>

    <!-- Portfolio Summary Cards -->
    <div class="row mb-4">
        <div class="col-md-3">
            <div class="card bg-primary text-white">
                <div class="card-body">
                    <h6 class="card-title">Portfolio Value (INR)</h6>
                    <h3 id="portfolioValueINR">Loading...</h3>
                    <p class="mb-0"><small id="portfolioChangeINR">--</small></p>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card bg-success text-white">
                <div class="card-body">
                    <h6 class="card-title">Portfolio Value (USD)</h6>
                    <h3 id="portfolioValueUSD">Loading...</h3>
                    <p class="mb-0"><small id="portfolioChangeUSD">--</small></p>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card bg-info text-white">
                <div class="card-body">
                    <h6 class="card-title">Total Stocks</h6>
                    <h3 id="stocksCount">--</h3>
                    <p class="mb-0"><small>Tracked Securities</small></p>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card bg-warning text-white">
                <div class="card-body">
                    <h6 class="card-title">Exchange Rate</h6>
                    <h3 id="exchangeRate">Loading...</h3>
                    <p class="mb-0"><small>USD to INR</small></p>
                </div>
            </div>
        </div>
    </div>

    <!-- Market Indices -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card">
                <div class="card-header bg-dark text-white">
                    <h5 class="mb-0">üìà Market Indices (Live)</h5>
                </div>
                <div class="card-body">
                    <div class="row" id="indicesContainer">
                        <div class="col text-center">
                            <div class="spinner-border" role="status">
                                <span class="visually-hidden">Loading...</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Top Movers and Sector Performance -->
    <div class="row mb-4">
        <!-- Top Movers -->
        <div class="col-md-6">
            <div class="card">
                <div class="card-header bg-success text-white">
                    <h5 class="mb-0">üöÄ Top Gainers</h5>
                </div>
                <div class="card-body">
                    <div class="list-group" id="gainersList">
                        <div class="text-center">Loading...</div>
                    </div>
                </div>
            </div>
            
            <div class="card mt-3">
                <div class="card-header bg-danger text-white">
                    <h5 class="mb-0">üìâ Top Losers</h5>
                </div>
                <div class="card-body">
                    <div class="list-group" id="losersList">
                        <div class="text-center">Loading...</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Sector Performance -->
        <div class="col-md-6">
            <div class="card">
                <div class="card-header bg-info text-white">
                    <h5 class="mb-0">üè¢ Sector Performance (5-Day)</h5>
                </div>
                <div class="card-body">
                    <canvas id="sectorChart" style="max-height: 400px;"></canvas>
                </div>
            </div>
        </div>
    </div>

    <!-- Recent Predictions - Full Width -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card">
                <div class="card-header bg-primary text-white">
                    <h5 class="mb-0">üéØ Recent Predictions</h5>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-sm">
                            <thead>
                                <tr>
                                    <th>Stock</th>
                                    <th>Date</th>
                                    <th>Predicted</th>
                                    <th>Actual</th>
                                    <th>Accuracy</th>
                                </tr>
                            </thead>
                            <tbody id="predictionsTable">
                                <tr><td colspan="5" class="text-center">Loading...</td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Last Updated -->
    <div class="row">
        <div class="col-12 text-center text-muted">
            <small>Last updated: <span id="lastUpdated">--</span></small>
            <button class="btn btn-sm btn-outline-primary ms-3" onclick="refreshAllData()">
                <i class="fas fa-sync-alt"></i> Refresh All
            </button>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
let sectorChart;

function loadPortfolioSummary() {
    fetch('/dashboard/api/portfolio-summary')
        .then(function(res) { return res.json(); })
        .then(function(data) {
            if (data.success) {
                document.getElementById('portfolioValueINR').textContent = '‚Çπ' + data.total_value_inr.toLocaleString();
                document.getElementById('portfolioValueUSD').textContent = '$' + data.total_value_usd.toLocaleString();
                document.getElementById('stocksCount').textContent = data.stocks_count;
                document.getElementById('exchangeRate').textContent = '$1 = ‚Çπ' + data.exchange_rate;
                
                var changeClass = data.total_change >= 0 ? 'text-success' : 'text-danger';
                var changeIcon = data.total_change >= 0 ? '‚ñ≤' : '‚ñº';
                document.getElementById('portfolioChangeINR').innerHTML = '<span class="' + changeClass + '">' + changeIcon + ' ' + Math.abs(data.total_change).toFixed(2) + '%</span>';
            }
        })
        .catch(function(error) {
            console.error('Portfolio error:', error);
        });
}

function loadMarketIndices() {
    fetch('/dashboard/api/market-indices')
        .then(function(res) { return res.json(); })
        .then(function(data) {
            if (data.success) {
                var container = document.getElementById('indicesContainer');
                container.innerHTML = '';
                
                data.indices.forEach(function(index) {
                    var changeClass = index.change_pct >= 0 ? 'text-success' : 'text-danger';
                    var changeIcon = index.change_pct >= 0 ? '‚ñ≤' : '‚ñº';
                    
                    var html = '<div class="col-md-2 col-sm-4 mb-3">' +
                               '<div class="text-center">' +
                               '<h6 class="mb-1">' + index.name + '</h6>' +
                               '<h5 class="mb-0">' + index.value.toLocaleString() + '</h5>' +
                               '<small class="' + changeClass + '">' + changeIcon + ' ' + index.change.toFixed(2) + ' (' + index.change_pct.toFixed(2) + '%)</small>' +
                               '</div></div>';
                    
                    container.innerHTML += html;
                });
                
                document.getElementById('lastUpdated').textContent = data.timestamp;
            }
        })
        .catch(function(error) {
            console.error('Indices error:', error);
        });
}

function loadTopMovers() {
    fetch('/dashboard/api/top-movers')
        .then(function(res) { return res.json(); })
        .then(function(data) {
            if (data.success) {
                // Gainers
                var gainersList = document.getElementById('gainersList');
                gainersList.innerHTML = '';
                
                data.gainers.forEach(function(stock, idx) {
                    var html = '<div class="list-group-item d-flex justify-content-between align-items-center">' +
                               '<div>' +
                               '<strong>' + (idx + 1) + '. ' + stock.symbol + '</strong>' +
                               '<br><small class="text-muted">' + stock.name + '</small>' +
                               '</div>' +
                               '<span class="badge bg-success">+' + stock.change.toFixed(2) + '%</span>' +
                               '</div>';
                    gainersList.innerHTML += html;
                });
                
                // Losers
                var losersList = document.getElementById('losersList');
                losersList.innerHTML = '';
                
                data.losers.forEach(function(stock, idx) {
                    var html = '<div class="list-group-item d-flex justify-content-between align-items-center">' +
                               '<div>' +
                               '<strong>' + (idx + 1) + '. ' + stock.symbol + '</strong>' +
                               '<br><small class="text-muted">' + stock.name + '</small>' +
                               '</div>' +
                               '<span class="badge bg-danger">' + stock.change.toFixed(2) + '%</span>' +
                               '</div>';
                    losersList.innerHTML += html;
                });
            }
        })
        .catch(function(error) {
            console.error('Movers error:', error);
        });
}

function loadSectorPerformance() {
    fetch('/dashboard/api/sector-performance')
        .then(function(res) { return res.json(); })
        .then(function(data) {
            if (data.success) {
                var ctx = document.getElementById('sectorChart').getContext('2d');
                
                var labels = data.sectors.map(function(s) { return s.sector; });
                var changes = data.sectors.map(function(s) { return s.change; });
                var colors = changes.map(function(c) { return c > 0 ? 'rgba(75, 192, 192, 0.7)' : 'rgba(255, 99, 132, 0.7)'; });
                
                if (sectorChart) {
                    sectorChart.destroy();
                }
                
                sectorChart = new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: labels,
                        datasets: [{
                            label: '5-Day Change (%)',
                            data: changes,
                            backgroundColor: colors
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: true,
                        plugins: {
                            legend: { display: false }
                        },
                        scales: {
                            y: {
                                beginAtZero: true,
                                title: { display: true, text: 'Change (%)' }
                            }
                        }
                    }
                });
            }
        })
        .catch(function(error) {
            console.error('Sector error:', error);
        });
}

function loadRecentPredictions() {
    fetch('/dashboard/api/recent-predictions')
        .then(function(res) { return res.json(); })
        .then(function(data) {
            if (data.success) {
                var tbody = document.getElementById('predictionsTable');
                tbody.innerHTML = '';
                
                data.predictions.forEach(function(pred) {
                    var html = '<tr>' +
                               '<td><strong>' + pred.stock + '</strong></td>' +
                               '<td>' + pred.date + '</td>' +
                               '<td>‚Çπ' + pred.predicted.toFixed(2) + '</td>' +
                               '<td>‚Çπ' + pred.actual.toFixed(2) + '</td>' +
                               '<td><span class="badge bg-success">' + pred.accuracy.toFixed(1) + '%</span></td>' +
                               '</tr>';
                    tbody.innerHTML += html;
                });
            }
        })
        .catch(function(error) {
            console.error('Predictions error:', error);
        });
}

function refreshAllData() {
    console.log('Refreshing all dashboard data...');
    loadPortfolioSummary();
    loadMarketIndices();
    loadTopMovers();
    loadSectorPerformance();
    loadRecentPredictions();
}

// Load data on page load
window.addEventListener('load', function() {
    refreshAllData();
    
    // Auto-refresh every 5 minutes
    setInterval(refreshAllData, 300000);
});
</script>

<style>
.card {
    box-shadow: 0 0.125rem 0.25rem rgba(0,0,0,0.075);
    border: none;
    margin-bottom: 1rem;
}

.card-header {
    font-weight: 600;
}

.list-group-item {
    border-left: none;
    border-right: none;
}

.list-group-item:first-child {
    border-top: none;
}

.list-group-item:last-child {
    border-bottom: none;
}
</style>
{% endblock %}