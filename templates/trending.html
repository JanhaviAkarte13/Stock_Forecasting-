{% extends "base.html" %}

{% block title %}Trending Stocks{% endblock %}

{% block content %}
<div class="container mt-5">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h1>üî• Trending Stocks (Real-Time)</h1>
        <button class="btn btn-primary" onclick="refreshAllData()">
            <i class="fas fa-sync-alt"></i> Refresh Now
        </button>
    </div>
    
    <div class="alert alert-info">
        <strong>üü¢ LIVE DATA:</strong> <span id="lastUpdated">Loading...</span>
        <br><small>Auto-refreshes every 5 minutes | Rate: <span id="exchangeRate">Loading...</span></small>
    </div>

    <ul class="nav nav-tabs mb-4">
        <li class="nav-item">
            <button class="nav-link active" data-bs-toggle="tab" data-bs-target="#gainers">üìà Gainers</button>
        </li>
        <li class="nav-item">
            <button class="nav-link" data-bs-toggle="tab" data-bs-target="#losers">üìâ Losers</button>
        </li>
        <li class="nav-item">
            <button class="nav-link" data-bs-toggle="tab" data-bs-target="#active">üíπ Most Active</button>
        </li>
        <li class="nav-item">
            <button class="nav-link" data-bs-toggle="tab" data-bs-target="#sectors">üè¢ Sectors</button>
        </li>
    </ul>

    <div class="tab-content">
        <div class="tab-pane fade show active" id="gainers">
            <div class="card">
                <div class="card-header bg-success text-white">
                    <h5 class="mb-0">Top 15 Gainers</h5>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-hover">
                            <thead>
                                <tr>
                                    <th>#</th><th>Symbol</th><th>Company</th>
                                    <th>USD</th><th>INR</th><th>Change</th><th>Volume</th>
                                </tr>
                            </thead>
                            <tbody id="gainersTable">
                                <tr><td colspan="7" class="text-center">Loading...</td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

        <div class="tab-pane fade" id="losers">
            <div class="card">
                <div class="card-header bg-danger text-white">
                    <h5 class="mb-0">Top 15 Losers</h5>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-hover">
                            <thead>
                                <tr>
                                    <th>#</th><th>Symbol</th><th>Company</th>
                                    <th>USD</th><th>INR</th><th>Change</th><th>Volume</th>
                                </tr>
                            </thead>
                            <tbody id="losersTable">
                                <tr><td colspan="7" class="text-center">Loading...</td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

        <div class="tab-pane fade" id="active">
            <div class="card">
                <div class="card-header bg-primary text-white">
                    <h5 class="mb-0">Top 15 Most Active</h5>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-hover">
                            <thead>
                                <tr>
                                    <th>#</th><th>Symbol</th><th>Company</th>
                                    <th>USD</th><th>INR</th><th>Change</th><th>Volume</th>
                                </tr>
                            </thead>
                            <tbody id="activeTable">
                                <tr><td colspan="7" class="text-center">Loading...</td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

        <div class="tab-pane fade" id="sectors">
            <div class="card">
                <div class="card-header bg-info text-white">
                    <h5 class="mb-0">Sector Performance</h5>
                </div>
                <div class="card-body">
                    <canvas id="sectorCanvas"></canvas>
                    <div class="table-responsive mt-4">
                        <table class="table">
                            <thead>
                                <tr><th>Sector</th><th>5-Day</th><th>Today</th><th>Price</th></tr>
                            </thead>
                            <tbody id="sectorTableBody">
                                <tr><td colspan="4" class="text-center">Loading...</td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
let sectorChart;

function updateTimestamp(timestamp, rate) {
    document.getElementById('lastUpdated').textContent = timestamp;
    document.getElementById('exchangeRate').textContent = `$1 = ‚Çπ${rate}`;
}

function loadGainers() {
    fetch('/trending/gainers')
        .then(res => res.json())
        .then(data => {
            if (data.success) {
                const tbody = document.getElementById('gainersTable');
                tbody.innerHTML = '';
                updateTimestamp(data.timestamp, data.exchange_rate);
                
                data.gainers.forEach((stock, idx) => {
                    tbody.innerHTML += `
                        <tr>
                            <td>${idx + 1}</td>
                            <td><span class="badge bg-success">${stock.symbol}</span> ${stock.market}</td>
                            <td>${stock.name}</td>
                            <td>${stock.price_usd}</td>
                            <td>‚Çπ${stock.price_inr}</td>
                            <td class="text-success"><strong>+${stock.change}%</strong></td>
                            <td>${stock.volume.toLocaleString()}</td>
                        </tr>
                    `;
                });
            }
        });
}

function loadLosers() {
    fetch('/trending/losers')
        .then(res => res.json())
        .then(data => {
            if (data.success) {
                const tbody = document.getElementById('losersTable');
                tbody.innerHTML = '';
                
                data.losers.forEach((stock, idx) => {
                    tbody.innerHTML += `
                        <tr>
                            <td>${idx + 1}</td>
                            <td><strong>${stock.symbol}</strong></td>
                            <td>${stock.name}</td>
                            <td>$${stock.price}</td>
                            <td>‚Çπ${stock.price_inr}</td>
                            <td class="text-danger">${stock.change}%</td>
                            <td>${stock.volume.toLocaleString()}</td>
                        </tr>
                    `;
                });
            }
        });
}

function loadMostActive() {
    fetch('/trending/most-active')
        .then(res => res.json())
        .then(data => {
            if (data.success) {
                const tbody = document.getElementById('activeTable');
                tbody.innerHTML = '';
                
                data.active.forEach((stock, idx) => {
                    const cls = stock.change >= 0 ? 'text-success' : 'text-danger';
                    const sign = stock.change >= 0 ? '+' : '';
                    
                    tbody.innerHTML += `
                        <tr>
                            <td>${idx + 1}</td>
                            <td><strong>${stock.symbol}</strong></td>
                            <td>${stock.name}</td>
                            <td>$${stock.price}</td>
                            <td>‚Çπ${stock.price_inr}</td>
                            <td class="${cls}">${sign}${stock.change}%</td>
                            <td>${stock.volume.toLocaleString()}</td>
                        </tr>
                    `;
                });
            }
        });
}

function loadSectors() {
    fetch('/trending/sector-performance')
        .then(res => res.json())
        .then(data => {
            if (data.success) {
                const ctx = document.getElementById('sectorCanvas').getContext('2d');
                const labels = data.sectors.map(s => s.sector);
                const changes = data.sectors.map(s => s.change);
                const colors = changes.map(c => c >= 0 ? 'rgba(75,192,192,0.7)' : 'rgba(255,99,132,0.7)');
                
                if (sectorChart) sectorChart.destroy();
                
                sectorChart = new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: labels,
                        datasets: [{
                            label: '5-Day %',
                            data: changes,
                            backgroundColor: colors
                        }]
                    },
                    options: {
                        responsive: true,
                        plugins: {
                            title: { display: true, text: 'Sector Performance' }
                        }
                    }
                });
                
                const tbody = document.getElementById('sectorTableBody');
                tbody.innerHTML = '';
                data.sectors.forEach(s => {
                    const e = s.change >= 0 ? 'üìà' : 'üìâ';
                    const c1 = s.change >= 0 ? 'text-success' : 'text-danger';
                    const c2 = s.today_change >= 0 ? 'text-success' : 'text-danger';
                    
                    tbody.innerHTML += `
                        <tr>
                            <td>${e} ${s.sector}</td>
                            <td class="${c1}">${s.change >= 0 ? '+' : ''}${s.change}%</td>
                            <td class="${c2}">${s.today_change >= 0 ? '+' : ''}${s.today_change}%</td>
                            <td>$${s.price}</td>
                        </tr>
                    `;
                });
            }
        });
}

function refreshAllData() {
    loadGainers();
    loadLosers();
    loadMostActive();
    loadSectors();
}

window.addEventListener('load', () => {
    refreshAllData();
    setInterval(refreshAllData, 300000);
});
</script>
{% endblock %}